---
layout: post
categories: blog
---

参考

1. https://medium.com/@threehappyer/deep-dive-into-c-20-coroutines-ef5a557d15cb
2. https://itnext.io/c-20-coroutines-complete-guide-7c3fc08db89d



#### 协程的关键字

1. `co_return` 用于指定协程的返回值，并且销毁协程的资源，并且在此以后协程不可重入。
2. `co_await` 用于暂停协程，直到满足等待的条件。
3. `co_yield` 用于向协程的调用者生成一个值，并暂时挂起协程。



#### 协程的核心组件

- **Coroutine handle**：这是指向协程状态的指针，可用于恢复或销毁协程。
- **Promise type of the coroutine**：这是一个**用户定义的类型**，用于定义协程的**返回对象**、**暂停**和**恢复**的逻辑以及如何处理**返回值**和**异常**。
- **Awaiter**：这是一个对象，用于定义协程在遇到`co_await`时的行为。awaiter 必须实现三个方法：`await_ready`、`await_suspend`和`await_resume`。



#### 协程的生命周期（流程）

1. **Creation**(创建协程帧)：用协程函数时，会创建一个协程帧，这是一个包含协程状态的数据结构。
2. **Initial Suspension**(初始暂停)：协程开始执行，但在运行任何实际代码之前，它会询问 promise 类型是否立即暂停。
3. **Execution**(执行)：协程开始执行用户定义的代码，直到遇到`co_await`、`co_yield`或`co_return`。
4. **Suspension**(暂停)：当协程遇到`co_await`或`co_yield`时，它会根据等待者的逻辑暂停。
5. **Resumption**(恢复)：协程可以在稍后的某个时间点恢复，继续执行，直到下一个暂停点或完成。
6. **Final Suspension**(最终暂停)：程执行完毕后，询问 promise 类型是否再次暂停。
7. **Destruction**(释放)：协程帧被破坏，释放所有资源。













